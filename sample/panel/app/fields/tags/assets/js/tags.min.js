!function(t){t.cursor=function(e){var n=t(e),i=n[0],r=n.val();if(!i.createTextRange)return i.selectionEnd;var a=document.selection.createRange().duplicate();return a.moveEnd("character",r.length),""==a.text?r.length:r.lastIndexOf(a.text)};var e=function(e){var n=this;return this.source=t(e),this.element=t("<div />"),this.input=t('<input class="tag-input" type="text" autocomplete="off" />'),this.tags=[],this.elements={},this.cursor=0,this.disabled=!1,this.autocomplete=this.source.data("url"),this.lowercase=this.source.data("lowercase"),this.separator=this.source.data("separator"),this.lowercase&&this.input.css("text-transform","lowercase"),this.separator||(this.separator=","),this.keys=function(t,e){t.on("keydown",function(t){return e[t.keyCode]?e[t.keyCode]():void 0})},this.next=function(t){return n.get(t).next()},this.prev=function(t){return n.get(t).prev()},this.first=function(){return n.element.find(".tag").first()},this.last=function(){return n.element.find(".tag").last()},this["goto"]=function(t,e){n[t](e).trigger("focus")},this.clean=function(e){var e=t.trim(e);return n.lowercase&&(e=e.toLowerCase()),e},this.get=function(e){return n.elements.filter(function(){return t(this).data("tag")==e.toLowerCase()})},this.select=function(t){return n.get(t).trigger("focus")},this.deselect=function(t){return n.get(t).trigger("blur")},this.store=function(){n.source.val(n.tags.join(n.separator))},this.add=function(e){e||(e=n.input.val());var e=n.clean(e),i=new RegExp(n.separator);if(e.match(i))return void t.each(e.split(n.separator),function(t,e){n.add(e)});if("array"==t.type(e))return void t.each(e,function(t,e){n.add(e)});if(!e||0==e.length||-1!=t.inArray(e,n.tags))return!1;n.tags.push(e);var r=t('<span data-tag="'+e.toLowerCase()+'" tabindex="-1" class="tag"></span>'),a=t('<i class="tag-x">&times;</i>'),o=t('<button class="tag-label" type="button">'+e+"</button>");r.append(o).append(a),r.on("focus",function(){o.focus()}),r.on("click",function(t){t.stopPropagation()}),a.on("click",function(){n.remove(e)}),n.keys(o,{8:function(){return n.remove(e),!1},27:function(){n.focus()},37:function(){return n["goto"]("prev",e),!1},39:function(){return n["goto"]("next",e),!1}}),n.input.before(r),n.elements=n.element.find(".tag"),n.input.val(""),n.store(),n.autocomplete&&n.input.data("autocomplete").ignore(e),n.element.trigger("tags:add")},this.focus=function(){n.input.trigger("focus")},this.remove=function(e){if(!n.disabled){n.tags=t.grep(n.tags,function(t){return t!=e});var i=n.prev(e).data("tag");if(n.get(e).remove(),n.elements=n.element.find(".tag"),i)n.select(i);else{var i=n.first().data("tag");i?n.select(i):n.focus()}n.store(),n.autocomplete&&n.input.data("autocomplete").unignore(e),n.element.trigger("tags:remove")}},this.init=function(){return n.element.attr("class",n.source.attr("class")),n.input.attr("id",n.source.attr("id")),n.source.attr("type","hidden").attr("id","").removeClass(),n.source.before(n.element),n.element.append(n.input),n.autocomplete&&(n.input.data("url",n.autocomplete),n.input.data("limit",5),n.input.data("sticky",!0),n.input.autocomplete(),n.input.on("autocomplete:add",function(){n.add()}),n.element.on("tags:add",function(){n.input.data("autocomplete").close()})),n.element.on("click",function(){n.focus()}),n.element.on("focusin",function(){n.element.addClass("input-is-focused"),n.element.trigger("tags:focus")}),n.element.on("focusout",function(){n.add(),n.element.removeClass("input-is-focused"),n.element.trigger("tags:blur")}),n.measure=t("<div></div>").css({display:"inline","font-size":n.input.css("font-size"),"font-family":n.input.css("font-family"),padding:n.input.css("padding"),visibility:"hidden",position:"absolute",top:-1e4,left:-1e4}),t("body").append(n.measure),n.keys(n.input,{13:function(){return n.add(),!1},9:function(){return 0==n.input.val().length?!0:(n.add(),!1)},188:function(){return n.add(),!1},8:function(){return 0==n.cursor?(n["goto"]("last"),!1):void 0},37:function(){return 0==n.cursor?(n["goto"]("last"),!1):void 0}}),n.input.on("keydown, keyup",function(){n.measure.text(n.input.val()),n.input.css("width",n.measure.outerWidth()+50),n.cursor=t.cursor(n.input)}),n.add(n.source.val()),n.source.attr("readonly")&&(n.disabled=!0,n.input.attr("readonly",!0).attr("tabindex",-1),n.element.find("button").attr("tabindex",-1)),n.element.trigger("tags:init"),{add:n.add,get:n.get,remove:n.remove,focus:n.focus,select:n.select,tags:function(){return n.tags},elements:function(){return n.elements},input:function(){return n.input}}},this.init()};t.fn.tags=function(){return this.each(function(){if(t(this).data("tags"))return t(this).data("tags");var n=new e(this);return t(this).data("tags",n),n})}}(jQuery);
